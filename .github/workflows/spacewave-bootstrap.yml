
name: SpaceWave Bootstrap (Unity 2022.3.34f1)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-spacewave-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create Unity project structure
        shell: bash
        run: |
          set -e
          mkdir -p Assets/SpaceWave/Runtime/Scripts/{Core,Gameplay,Obstacles,Systems,UI}
          mkdir -p Assets/SpaceWave/{Editor,Scenes,Input,Prefabs,Materials,Shaders,Audio,Tests/PlayMode}
          mkdir -p Packages ProjectSettings

          # ProjectSettings
          cat > ProjectSettings/ProjectVersion.txt << 'EOF'
          m_EditorVersion: 2022.3.34f1
          EOF

          # Packages/manifest.json (URP/TMP/InputSystem)
          cat > Packages/manifest.json << 'EOF'
          {
            "dependencies": {
              "com.unity.render-pipelines.universal": "14.0.11",
              "com.unity.textmeshpro": "3.0.6",
              "com.unity.inputsystem": "*",
              "com.unity.ugui": "1.0.0",
              "com.unity.test-framework": "1.3.9",
              "com.unity.modules.audio": "1.0.0",
              "com.unity.modules.physics": "1.0.0",
              "com.unity.modules.physics2d": "1.0.0",
              "com.unity.modules.unitywebrequest": "1.0.0"
            }
          }
          EOF

          # README
          cat > README.md << 'EOF'
          # SpaceWave (Unity 2022.3.34f1 LTS)
          Wave-based Arcade prêt Android (APK), URP + Bloom, Input System, TextMeshPro.
          - Ouvrir avec Unity 2022.3.34f1 LTS
          - Scènes auto-créées (MainMenu/Game/Loading), URP assigné, Android IL2CPP ARM64.
          - Build APK : menu SpaceWave → Build → Build Android APK
          EOF

          # asmdefs
          cat > Assets/SpaceWave/Runtime/SpaceWave.Runtime.asmdef << 'EOF'
          { "name": "SpaceWave.Runtime", "includePlatforms": ["Editor","Android","WindowsEditor","OSXEditor","LinuxEditor"], "autoReferenced": true }
          EOF
          cat > Assets/SpaceWave/Editor/SpaceWave.Editor.asmdef << 'EOF'
          { "name": "SpaceWave.Editor", "references": ["SpaceWave.Runtime"], "includePlatforms": ["Editor"], "autoReferenced": true }
          EOF

          # Input System map
          cat > Assets/SpaceWave/Input/Controls.inputactions << 'EOF'
          {
            "name": "Controls",
            "maps": [
              {
                "name": "Gameplay",
                "actions": [{ "name": "Press", "type": "Button", "expectedControlType": "Button" }],
                "bindings": [
                  { "path": "<Touchscreen>/press", "action": "Press" },
                  { "path": "<Mouse>/leftButton", "action": "Press" },
                  { "path": "<Keyboard>/space", "action": "Press" }
                ]
              }
            ],
            "controlSchemes": []
          }
          EOF

          # --- SCRIPTS (Gameplay) ---
          cat > Assets/SpaceWave/Runtime/Scripts/Gameplay/WaveController.cs << 'EOF'
// Strict constant-speed vertical control (no inertia)
using UnityEngine;
#if ENABLE_INPUT_SYSTEM
using UnityEngine.InputSystem;
#endif
namespace SpaceWave.Gameplay {
  public class WaveController : MonoBehaviour {
    [SerializeField] float verticalSpeed = 8f;
    [SerializeField] float yMin = -4.5f, yMax = 4.5f;
    bool isPressing; Vector3 pos;
    void Awake(){ Application.targetFrameRate = 60; QualitySettings.vSyncCount = 0; pos = transform.position; }
#if ENABLE_INPUT_SYSTEM
    public void OnPress(InputAction.CallbackContext ctx){ if (ctx.started || ctx.performed) isPressing = true; if (ctx.canceled) isPressing = false; }
#else
    void UpdateInputLegacy(){ isPressing = Input.GetKey(KeyCode.Space) || Input.GetMouseButton(0); }
#endif
    void Update(){
#if !ENABLE_INPUT_SYSTEM
      UpdateInputLegacy();
#endif
      float dy = (isPressing ? +verticalSpeed : -verticalSpeed) * Time.deltaTime;
      pos.y = Mathf.Clamp(pos.y + dy, yMin, yMax);
      transform.position = pos;
    }
  }
}
          EOF

          cat > Assets/SpaceWave/Runtime/Scripts/Gameplay/LevelManager.cs << 'EOF'
using UnityEngine;
namespace SpaceWave.Gameplay {
  public class LevelManager : MonoBehaviour {
    [SerializeField] bool endlessMode = true;
    public bool EndlessMode => endlessMode;
    public void SetEndless(bool v) => endlessMode = v;
  }
}
          EOF

          # --- Obstacles (procédural continu) ---
          cat > Assets/SpaceWave/Runtime/Scripts/Obstacles/ProceduralObstacle.cs << 'EOF'
using UnityEngine;
[RequireComponent(typeof(BoxCollider2D)), RequireComponent(typeof(SpriteRenderer))]
public class ProceduralObstacle : MonoBehaviour {
  float scrollSpeed; SpriteRenderer sr;
  public void Configure(float speed, Vector2 size, Color color){
    scrollSpeed = speed; sr = GetComponent<SpriteRenderer>(); sr.color = color;
    var bc = GetComponent<BoxCollider2D>(); bc.size = size;
    transform.localScale = new Vector3(size.x, size.y, 1f);
  }
  void Update(){ transform.Translate(Vector3.left * scrollSpeed * Time.deltaTime, Space.World);
    if (transform.position.x < -40f) gameObject.SetActive(false); }
}
          EOF

          cat > Assets/SpaceWave/Runtime/Scripts/Obstacles/ObstacleGenerator.cs << 'EOF'
using UnityEngine;
public class ObstacleGenerator : MonoBehaviour {
  [SerializeField] Transform spawnRoot;
  [SerializeField] float scrollSpeed = 10f, spacing = 10f;
  [SerializeField] Color colorCircle = new Color(0.3f,0.9f,1f), colorSquare = new Color(0.7f,0.2f,1f), colorTriangle = new Color(1f,0.2f,0.6f);
  [SerializeField] GameObject obstaclePrefab;
  float nextX;
  void Start(){ if(!spawnRoot) spawnRoot = transform; nextX = 20f; }
  void Update(){ EnsureContinuous(); }
  void EnsureContinuous(){ float camRight = 30f; while (nextX < camRight){ SpawnPattern(nextX); nextX += spacing; } }
  void SpawnPattern(float baseX){
    int selector = Random.Range(0,3); float y = Random.Range(-3.5f,3.5f);
    var go = Instantiate(obstaclePrefab, spawnRoot); go.transform.position = new Vector3(baseX, y, 0);
    var po = go.GetComponent<ProceduralObstacle>(); Vector2 size; Color c;
    switch(selector){ case 0: size=new Vector2(1.5f,4f); c=colorSquare; break; case 1: size=new Vector2(1.2f,1.2f); c=colorCircle; break; default: size=new Vector2(1.8f,2.0f); c=colorTriangle; break; }
    po.Configure(scrollSpeed, size, c);
  }
}
          EOF

          # --- Core/Systems ---
          cat > Assets/SpaceWave/Runtime/Scripts/Core/ObjectPool.cs << 'EOF'
using UnityEngine; using System.Collections.Generic;
[System.Serializable] public class PoolEntry{ public string key; public GameObject prefab; public int preload = 32; }
public class ObjectPool : MonoBehaviour {
  [SerializeField] List<PoolEntry> entries; readonly Dictionary<string, Queue<GameObject>> pools = new();
  void Awake(){ foreach(var e in entries){ var q=new Queue<GameObject>(); for(int i=0;i<e.preload;i++){ var p=Instantiate(e.prefab,transform); p.SetActive(false); q.Enqueue(p);} pools[e.key]=q; } }
  public GameObject Get(string key){ var q=pools[key]; if(q.Count==0){ var prefab=entries.Find(x=>x.key==key).prefab; var inst=Instantiate(prefab,transform); inst.SetActive(false); return inst; } return q.Dequeue(); }
  public void Return(string key, GameObject go){ go.SetActive(false); pools[key].Enqueue(go); }
}
          EOF

          cat > Assets/SpaceWave/Runtime/Scripts/Systems/SaveSystem.cs << 'EOF'
using UnityEngine; using System.IO;
[System.Serializable] public class SaveData{ public int coins; public string equippedSkin="default"; public string[] ownedSkins=new[]{"default"}; }
public static class SaveSystem {
  static string PathFile => System.IO.Path.Combine(Application.persistentDataPath, "save.json");
  public static SaveData Load(){ if(!File.Exists(PathFile)) return new SaveData(); var json=File.ReadAllText(PathFile); return JsonUtility.FromJson<SaveData>(json); }
  public static void Save(SaveData data){ var json=JsonUtility.ToJson(data,true); File.WriteAllText(PathFile,json); }
}
          EOF

          cat > Assets/SpaceWave/Runtime/Scripts/Systems/Shop.cs << 'EOF'
using UnityEngine; using System.Collections.Generic;
public class Shop : MonoBehaviour {
  public void BuySkin(string skinId, int price){
    var data = SaveSystem.Load();
    if(data.coins >= price){
      data.coins -= price; var list = new List<string>(data.ownedSkins);
      if(!list.Contains(skinId)) list.Add(skinId); data.ownedSkins = list.ToArray(); data.equippedSkin = skinId;
      SaveSystem.Save(data);
    }
  }
}
          EOF

          cat > Assets/SpaceWave/Runtime/Scripts/Systems/AudioManager.cs << 'EOF'
using UnityEngine;
public class AudioManager : MonoBehaviour {
  [SerializeField] AudioSource music, sfx;
  void Start(){ if(!music) music=gameObject.AddComponent<AudioSource>(); if(!sfx) sfx=gameObject.AddComponent<AudioSource>();
    music.loop=true; music.clip=CreateLoop(); music.volume=0.35f; music.Play(); }
  public void PlayClick()=>sfx.PlayOneShot(CreateClick(0.1f));
  public void PlayCoin()=>sfx.PlayOneShot(CreateClick(0.2f));
  public void PlayHit()=>sfx.PlayOneShot(CreateClick(0.05f));
  AudioClip CreateLoop(){ int sr=48000, samples=sr*2; float[] d=new float[samples]; float f1=220f,f2=277.18f,f3=329.63f;
    for(int i=0;i<samples;i++){ float t=i/(float)sr; float env=0.5f*(1f-Mathf.Cos(2f*Mathf.PI*t/2f));
      d[i]=0.2f*env*(Mathf.Sin(2*Mathf.PI*f1*t)+0.6f*Mathf.Sin(2*Mathf.PI*f2*t)+0.4f*Mathf.Sin(2*Mathf.PI*f3*t)); }
    var clip=AudioClip.Create("Loop",samples,1,sr,false); clip.SetData(d,0); return clip; }
  AudioClip CreateClick(float dur){ int sr=48000, samples=Mathf.CeilToInt(sr*dur); float[] d=new float[samples];
    for(int i=0;i<samples;i++){ float t=i/(float)sr; float env=Mathf.Exp(-t*30f); d[i]=env*(Random.value*2f-1f)*0.4f; }
    var clip=AudioClip.Create("Click",samples,1,sr,false); clip.SetData(d,0); return clip; }
}
          EOF

          # --- UI ---
          cat > Assets/SpaceWave/Runtime/Scripts/UI/UIBootstrap.cs << 'EOF'
using UnityEngine; using UnityEngine.SceneManagement;
public class UIBootstrap : MonoBehaviour {
  public void PlayEndless()=>SceneManager.LoadScene("Game");
  public void Quit(){ #if UNITY_EDITOR UnityEditor.EditorApplication.isPlaying=false; #else Application.Quit(); #endif }
}
          EOF

          # --- Editor Bootstrap: URP + Scenes + Android + Prefab ---
          cat > Assets/SpaceWave/Editor/Bootstrap.cs << 'EOF'
using UnityEditor; using UnityEngine; using UnityEditor.SceneManagement; using UnityEngine.SceneManagement;
using UnityEngine.Rendering; using UnityEngine.Rendering.Universal;
[InitializeOnLoad]
public static class SpaceWaveBootstrap {
  static SpaceWaveBootstrap(){ EditorApplication.update += TrySetup; }
  static bool done;
  static void TrySetup(){ if(done) return; done=true; EnsureURP(); EnsureScenes(); ConfigureAndroid(); Debug.Log("SpaceWave: auto-config done."); }
  static void EnsureURP(){
    if(GraphicsSettings.renderPipelineAsset == null){
      var guids = AssetDatabase.FindAssets("t:UniversalRenderPipelineAsset");
      UniversalRenderPipelineAsset urp = null;
      if(guids.Length>0){ urp = AssetDatabase.LoadAssetAtPath<UniversalRenderPipelineAsset>(AssetDatabase.GUIDToAssetPath(guids[0])); }
      else { urp = ScriptableObject.CreateInstance<UniversalRenderPipelineAsset>(); AssetDatabase.CreateAsset(urp,"Assets/SpaceWave/URP_Asset.asset"); AssetDatabase.SaveAssets(); }
      GraphicsSettings.renderPipelineAsset = urp; QualitySettings.renderPipeline = urp;
    }
  }
  static void EnsureScenes(){
    System.IO.Directory.CreateDirectory("Assets/SpaceWave/Scenes");
    CreateSceneIfMissing("MainMenu", BuildMenu);
    CreateSceneIfMissing("Game", BuildGame);
    CreateSceneIfMissing("Loading", BuildLoading);
    var list = new System.Collections.Generic.List<EditorBuildSettingsScene>(EditorBuildSettings.scenes);
    void Add(string p){ if(!list.Exists(s=>s.path==p)) list.Add(new EditorBuildSettingsScene(p,true)); }
    Add("Assets/SpaceWave/Scenes/MainMenu.unity");
    Add("Assets/SpaceWave/Scenes/Game.unity");
    Add("Assets/SpaceWave/Scenes/Loading.unity");
    EditorBuildSettings.scenes = list.ToArray();
  }
  static void CreateSceneIfMissing(string name, System.Action<Scene> builder){
    var path=$"Assets/SpaceWave/Scenes/{name}.unity";
    if(!System.IO.File.Exists(path)){ var scene=EditorSceneManager.NewScene(NewSceneSetup.EmptyScene, NewSceneMode.Single); builder(scene); EditorSceneManager.SaveScene(scene,path); }
  }
  static void BuildMenu(Scene scene){
    var camGO=new GameObject("Main Camera"); var cam=camGO.AddComponent<Camera>(); cam.orthographic=true; cam.orthographicSize=5; camGO.tag="MainCamera";
    var canvasGO=new GameObject("Canvas"); var canvas=canvasGO.AddComponent<UnityEngine.Canvas>(); canvas.renderMode=UnityEngine.RenderMode.ScreenSpaceOverlay;
    var scaler=canvasGO.AddComponent<UnityEngine.UI.CanvasScaler>(); scaler.uiScaleMode=UnityEngine.UI.CanvasScaler.ScaleMode.ScaleWithScreenSize; scaler.referenceResolution=new Vector2(1920,1080);
    canvasGO.AddComponent<UnityEngine.UI.GraphicRaycaster>();
    new GameObject("EventSystem", typeof(UnityEngine.EventSystems.EventSystem), typeof(UnityEngine.EventSystems.StandaloneInputModule));
    var title=new GameObject("Title"); title.transform.SetParent(canvasGO.transform);
    var t=title.AddComponent<TMPro.TextMeshProUGUI>(); t.text="SPACEWAVE"; t.fontSize=96; t.alignment=TMPro.TextAlignmentOptions.Center;
    var rt=(RectTransform)title.transform; rt.anchorMin=rt.anchorMax=new Vector2(0.5f,0.8f); rt.sizeDelta=new Vector2(800,200); rt.anchoredPosition=Vector2.zero;
    CreateButton(canvasGO.transform,"Play Endless",new Vector2(0.5f,0.55f), ()=> UnityEditor.EditorApplication.isPlaying=false);
    CreateButton(canvasGO.transform,"Levels",new Vector2(0.5f,0.45f), ()=> {});
    CreateButton(canvasGO.transform,"Shop",new Vector2(0.5f,0.35f), ()=> {});
    CreateButton(canvasGO.transform,"Settings",new Vector2(0.5f,0.25f), ()=> {});
  }
  static void CreateButton(Transform parent,string label,Vector2 anchor,System.Action onClick){
    var go=new GameObject(label); go.transform.SetParent(parent);
    var rt=go.AddComponent<RectTransform>(); rt.anchorMin=rt.anchorMax=anchor; rt.sizeDelta=new Vector2(400,100); rt.anchoredPosition=Vector2.zero;
    var img=go.AddComponent<UnityEngine.UI.Image>(); img.color=new Color(0.1f,0.1f,0.15f,0.85f);
    var btn=go.AddComponent<UnityEngine.UI.Button>();
    var txtGO=new GameObject("Text"); txtGO.transform.SetParent(go.transform);
    var txt=txtGO.AddComponent<TMPro.TextMeshProUGUI>(); txt.text=label; txt.alignment=TMPro.TextAlignmentOptions.Center; txt.fontSize=48;
    var trt=(RectTransform)txtGO.transform; trt.anchorMin=Vector2.zero; trt.anchorMax=Vector2.one; trt.offsetMin=Vector2.zero; trt.offsetMax=Vector2.zero;
    btn.onClick.AddListener(()=> onClick());
  }
  static void BuildGame(Scene scene){
    var camGO=new GameObject("Main Camera"); var cam=camGO.AddComponent<Camera>(); cam.orthographic=true; cam.orthographicSize=5; camGO.tag="MainCamera";
    var player=new GameObject("Player"); player.transform.position=new Vector3(-6f,0,0);
    player.AddComponent<SpaceWave.Gameplay.WaveController>(); player.AddComponent<SpriteRenderer>(); player.AddComponent<BoxCollider2D>();
    var genGO=new GameObject("ObstacleGenerator"); genGO.AddComponent<ObstacleGenerator>(); genGO.AddComponent<AudioManager>();
    var prefab=new GameObject("ObstaclePrefab"); prefab.AddComponent<SpriteRenderer>(); prefab.AddComponent<BoxCollider2D>(); prefab.AddComponent<ProceduralObstacle>();
    UnityEditor.PrefabUtility.SaveAsPrefabAsset(prefab, "Assets/SpaceWave/Prefabs/ObstaclePrefab.prefab"); Object.DestroyImmediate(prefab);
    var gen=genGO.GetComponent<ObstacleGenerator>();
    gen.GetType().GetField("obstaclePrefab", System.Reflection.BindingFlags.NonPublic|System.Reflection.BindingFlags.Instance)
      .SetValue(gen, AssetDatabase.LoadAssetAtPath<GameObject>("Assets/SpaceWave/Prefabs/ObstaclePrefab.prefab"));
  }
  static void BuildLoading(Scene scene){
    var camGO=new GameObject("Main Camera"); var cam=camGO.AddComponent<Camera>(); cam.orthographic=true; cam.orthographicSize=5; camGO.tag="MainCamera";
    var canvas=new GameObject("Canvas"); canvas.AddComponent<UnityEngine.Canvas>().renderMode=UnityEngine.RenderMode.ScreenSpaceOverlay;
    canvas.AddComponent<UnityEngine.UI.CanvasScaler>(); canvas.AddComponent<UnityEngine.UI.GraphicRaycaster>();
    var go=new GameObject("LoadingText"); go.transform.SetParent(canvas.transform);
    var txt=go.AddComponent<TMPro.TextMeshProUGUI>(); txt.text="Loading..."; txt.fontSize=72; txt.alignment=TMPro.TextAlignmentOptions.Center;
    var rt=(RectTransform)go.transform; rt.anchorMin=rt.anchorMax=new Vector2(0.5f,0.5f); rt.sizeDelta=new Vector2(600,200); rt.anchoredPosition=Vector2.zero;
  }
  static void ConfigureAndroid(){
    PlayerSettings.defaultIsFullScreen=true;
    PlayerSettings.allowedAutorotateToPortrait=false; PlayerSettings.allowedAutorotateToPortraitUpsideDown=false;
    PlayerSettings.allowedAutorotateToLandscapeLeft=true; PlayerSettings.allowedAutorotateToLandscapeRight=true;
    PlayerSettings.defaultScreenWidth=1920; PlayerSettings.defaultScreenHeight=1080;
    PlayerSettings.SetScriptingBackend(BuildTargetGroup.Android, ScriptingImplementation.IL2CPP);
    PlayerSettings.Android.targetArchitectures=AndroidArchitecture.ARM64;
    PlayerSettings.Android.minSdkVersion=AndroidSdkVersions.AndroidApiLevel24;
#if !UNITY_2023_1_OR_NEWER
    PlayerSettings.Android.targetSdkVersion=AndroidSdkVersions.AndroidApiLevel34;
#endif
    QualitySettings.vSyncCount=0; Debug.Log("Android: IL2CPP ARM64, minSdk 24, targetSdk 34.");
  }
}
          EOF

      - name: Commit project to branch
        uses: EndBug/add-and-commit@v9
        with:
          add: "."
          message: "Add SpaceWave Unity 2022.3.34f1 complete project"
          new_branch: "spacewave-2022.3.34f1"

      - name: Create ZIP artifact
        run: zip -r SpaceWave_2022.3.34f1.zip Assets ProjectSettings Packages README.md

      - name: Create Release with ZIP
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v2022.3.34f1-initial
          name: "SpaceWave 2022.3.34f1 — Initial"
          body: "Complete Unity project (URP/TMP/InputSystem, Android IL2CPP ARM64)."
          draft: false
          prerelease: false
          files: SpaceWave_2022.3.34f1.zip
